# Codebase Structure

**Analysis Date:** 2026-02-07

## Directory Layout

```
swift-mcp/
├── build/                    # Compiled JavaScript output (generated by tsc)
├── docs/                     # Documentation assets
├── demo/                     # Demo scripts and examples
├── scripts/                  # Utility scripts (e.g., E2E tests)
├── src/
│   ├── cli/                  # Command-line interfaces for non-MCP operations
│   ├── config/               # Configuration management and source definitions
│   ├── integration/          # Integration tests (client simulation, behavior verification)
│   ├── sources/              # Content sources (free and premium)
│   ├── tools/                # MCP tool handlers and registry
│   ├── utils/                # Shared utilities (caching, search, formatting, etc.)
│   └── index.ts              # MCP server entry point
├── node_modules/             # Dependencies (not committed)
├── .planning/                # GSD planning documents
├── .github/                  # GitHub workflows
├── .opencode/                # GSD framework and hooks
├── .env                      # Environment variables (not committed, has secrets)
├── .env.example              # Example environment configuration
├── package.json              # Project manifest and scripts
├── tsconfig.json             # TypeScript compilation settings
├── eslint.config.js          # ESLint configuration
└── README.md                 # Project overview
```

## Directory Purposes

**src/:**
- Purpose: All source code compiled to build/
- Contains: Entry point, tool handlers, sources, utilities
- Key files: `index.ts` (server entry), `tools/handlers/*.ts` (tool logic)

**src/cli/:**
- Purpose: Non-MCP command-line tools for user operations
- Contains: Source listing, Patreon OAuth setup
- Key files:
  - `sources.ts`: Lists sources and their enable/disable status
  - `patreon.ts`: Handles Patreon OAuth flow and token management

**src/config/:**
- Purpose: Source definitions, configuration persistence, keyword databases
- Contains: Source manager, available source definitions, Swift keyword mappings
- Key files:
  - `sources.ts`: SourceManager class (enable/disable, persistence, status)
  - `swift-keywords.ts`: Topic keywords and quality signals per source
  - `creators.ts`: Patreon creator metadata

**src/sources/:**
- Purpose: Content fetchers for each provider (free or premium)
- Contains: RSS pattern sources and OAuth implementations
- Layout:
  - `free/`: Sundell, VanderLee, NilCoalescing, PointFree sources
  - `premium/`: Patreon and YouTube sources
  - Each with `__tests__/` subdirectory

**src/sources/free/:**
- Purpose: RSS-based content sources (no authentication)
- Key files:
  - `rssPatternSource.ts`: Abstract base class for RSS feeds
  - `sundell.ts`: Swift by Sundell source (subclass)
  - `vanderlee.ts`: Antoine van der Lee source (subclass)
  - `nilcoalescing.ts`: Nil Coalescing source (subclass)
  - `pointfree.ts`: Point-Free source (subclass)

**src/sources/premium/:**
- Purpose: Authenticated content sources (Patreon, YouTube)
- Key files:
  - `patreon.ts`: Main Patreon source with OAuth
  - `patreon-oauth.ts`: OAuth token management
  - `patreon-dl.ts`: Content downloader from Patreon posts
  - `youtube.ts`: YouTube transcript fetching

**src/tools/:**
- Purpose: MCP tool handler registration and dispatch
- Contains: Handler registry, type definitions, handler implementations
- Key files:
  - `index.ts`: Barrel export, registers all handlers on import
  - `registry.ts`: Central handler lookup (getHandler, registerHandler)
  - `types.ts`: ToolResponse, ToolContext, ToolHandler types

**src/tools/handlers/:**
- Purpose: Implementation of each MCP tool
- Key files (one handler per tool):
  - `getSwiftPattern.ts`: Search free sources by topic with quality filtering
  - `searchSwiftContent.ts`: Full-text search with semantic recall fallback
  - `listContentSources.ts`: Return source status and enable/disable info
  - `enableSource.ts`: Mark source as enabled in config
  - `setupPatreon.ts`: Initiate OAuth flow for Patreon
  - `getPatreonPatterns.ts`: Search Patreon content by topic

**src/utils/:**
- Purpose: Shared utilities for all layers (caching, search, formatting, logging)
- Key files:
  - `cache.ts`: FileCache with dual memory/disk layers
  - `search.ts`: MiniSearch wrapper with stemming/fuzzy matching
  - `semantic-recall.ts`: Embeddings-based search using @xenova/transformers
  - `source-registry.ts`: Singleton source instances with in-flight dedup
  - `pattern-formatter.ts`: Consistent response formatting
  - `intent-cache.ts`: Caches search results by query+sources+quality key
  - `memvid-memory.ts`: Optional persistent memory using memvid SDK
  - `response-helpers.ts`: MCP response constructors
  - `errors.ts`: Structured error logging
  - `logger.ts`: Pino logger instance
  - `http.ts`: HTTP fetch utilities with headers
  - `fetch.ts`: Custom fetch wrapper
  - `swift-analysis.ts`: Topic detection, code detection, relevance scoring
  - `search-terms.ts`: Query normalization and tokenization
  - `paths.ts`: Configuration directory paths
  - `inflight-dedup.ts`: Request deduplication
  - `extract-cookie.ts`: Cookie extraction from HTTP responses

**src/integration/:**
- Purpose: Integration tests verifying behavior across layers
- Key files:
  - `test-client.ts`: Test MCP client that simulates Claude
  - `__tests__/mcp-client.test.ts`: MCP server integration tests
  - `__tests__/cache-behavior.test.ts`: Cache layer behavior verification
  - `__tests__/response-quality.test.ts`: Response formatting and quality checks

**build/:**
- Purpose: Compiled JavaScript output (generated)
- Contains: .js files corresponding to src/ structure
- Committed: No (generated by `npm run build`)
- Entry: `build/index.js` is the executable entry point

**src/config/__tests__/:**
- Purpose: Tests for source manager and configuration
- Key files:
  - `sources.test.ts`: SourceManager enable/disable, persistence

**src/sources/free/__tests__/:**
- Purpose: Tests for individual free sources
- Key files (one per source):
  - `sundell.test.ts`: Tests Sundell source RSS parsing
  - `vanderlee.test.ts`: Tests VanderLee source
  - etc.
  - `rssPatternSource.test.ts`: Base class tests

**src/sources/premium/__tests__/:**
- Purpose: Tests for premium sources
- Key files:
  - `patreon-integration.test.ts`: Patreon OAuth and fetching

**src/tools/__tests__/:**
- Purpose: Tests for tool handlers
- Key files:
  - `registry.test.ts`: Handler registration and lookup

**src/tools/handlers/__tests__/:**
- Purpose: Tests for individual tool handlers
- Key files:
  - `handlers.test.ts`: Tests core handlers (getSwiftPattern, searchSwiftContent)
  - `getPatreonPatterns.test.ts`: Tests Patreon handler

**src/utils/__tests__/:**
- Purpose: Tests for utility modules
- Key files (one per utility or group):
  - `cache.test.ts`: FileCache get/set/TTL/cleanup
  - `search.test.ts`: Search index and ranking
  - `semantic-recall.test.ts`: Embeddings search
  - `intent-cache.test.ts`: Intent caching behavior
  - `source-registry.test.ts`: Source deduplication
  - `pattern-formatter.test.ts`: Response formatting
  - `response-helpers.test.ts`: Response creation
  - `swift-analysis.test.ts`: Topic/code detection
  - `search-terms.test.ts`: Query normalization
  - `memvid-memory.test.ts`: Persistent memory

## Key File Locations

**Entry Points:**
- `src/index.ts`: MCP server startup, CLI routing, tool registration
- `src/cli/sources.ts`: CLI for listing sources
- `src/cli/patreon.ts`: CLI for Patreon setup
- `build/index.js`: Compiled executable (target: `swift-patterns-mcp` bin)

**Configuration:**
- `tsconfig.json`: TypeScript compiler options (target ES2022, Node16 modules)
- `eslint.config.js`: ESLint rules and globals
- `.env`: Environment variables (PATREON_CLIENT_ID, etc., not committed)
- `.env.example`: Example env vars
- `package.json`: Dependencies, scripts, bin target

**Core Logic:**
- `src/config/sources.ts`: SourceManager (enable/disable, persistence)
- `src/tools/registry.ts`: Handler registry lookup
- `src/sources/free/rssPatternSource.ts`: Base class for all RSS sources
- `src/utils/source-registry.ts`: Source instance caching and deduplication
- `src/utils/cache.ts`: Two-tier caching system
- `src/utils/search.ts`: MiniSearch wrapper for pattern searching

**Testing:**
- `vitest.config.js` or `vitest.config.ts`: Vitest configuration (not visible, likely inferred)
- `src/**/__tests__/*.test.ts`: Test files co-located with implementation

## Naming Conventions

**Files:**
- Implementation: camelCase (e.g., `getSwiftPattern.ts`, `rssPatternSource.ts`)
- Tests: Same name + `.test.ts` suffix (e.g., `cache.test.ts`)
- CLI: kebab-case (e.g., `sources.ts`, `patreon.ts`)
- Utilities: camelCase (e.g., `response-helpers.ts`)
- Directories: kebab-case for utility/tool groups (e.g., `__tests__`, `free`, `premium`)

**Classes:**
- PascalCase (e.g., `RssPatternSource`, `SourceManager`, `FileCache`)
- Source subclasses: `{CreatorName}Source` (e.g., `SundellSource`)

**Functions:**
- camelCase (e.g., `getHandler`, `registerHandler`, `searchMultipleSources`)
- Handler functions: `{action}Handler` (e.g., `getSwiftPatternHandler`)
- Utilities: camelCase prefixed by function (e.g., `createTextResponse`, `logError`)

**Variables:**
- camelCase (e.g., `sourceManager`, `intentKey`, `cachedSearch`)
- Constants: UPPER_SNAKE_CASE (e.g., `DEFAULT_TTL`, `CORE_TOOLS`)

**Types:**
- PascalCase for interfaces and types (e.g., `ToolResponse`, `BasePattern`, `SourceConfig`)
- Suffixes for specific types: `...Pattern` (e.g., `SundellPattern`), `...Source` (e.g., `FreeSource`)

**Directories:**
- kebab-case (e.g., `src/cli`, `src/tools/handlers`, `src/sources/free`)
- Exception: `__tests__` for test directories

## Where to Add New Code

**New Tool/Handler:**
1. Create handler function: `src/tools/handlers/{action}.ts`
   - Implement ToolHandler interface: `(args, context) => Promise<ToolResponse>`
   - Use intentCache for caching where appropriate
   - Call formatters for consistent response
2. Register handler: Add to imports and `registerHandler()` call in `src/tools/index.ts`
3. Add tool definition: Add Tool object to `CORE_TOOLS` or `PATREON_TOOLS` array in `src/index.ts`
4. Add tests: `src/tools/handlers/__tests__/{action}.test.ts`

**New Content Source:**
- Free RSS source:
  1. Create: `src/sources/free/{source-name}.ts` extending `RssPatternSource`
  2. Define: Feed URL, topic keywords, quality signals
  3. Add to AVAILABLE_SOURCES in `src/config/sources.ts`
  4. Create test: `src/sources/free/__tests__/{source-name}.test.ts`
- Premium source:
  1. Create: `src/sources/premium/{source-name}.ts` implementing FreeSource interface
  2. Import conditionally in `src/index.ts` (like patreon currently)
  3. Add authentication/setup if needed
  4. Create test: `src/sources/premium/__tests__/{source-name}.test.ts`

**New Utility:**
- Create: `src/utils/{utility-name}.ts`
- Export public functions/classes
- Add tests: `src/utils/__tests__/{utility-name}.test.ts`
- Import in handlers/sources as needed

**New CLI Command:**
1. Create: `src/cli/{command}.ts` (executable with shebang)
2. Add to CLI_COMMANDS map in `src/index.ts`
3. Add npm script: `scripts.{command}: "node build/cli/{command}.js"`
4. No tests required for CLI (integration tests cover behavior)

**Configuration/Keywords:**
- Source-specific keywords: `src/config/swift-keywords.ts` in `createSourceConfig()` calls
- Add creator metadata to `src/config/creators.ts` if Patreon creator

## Special Directories

**build/:**
- Purpose: Compiled JavaScript output
- Generated: By `npm run build` (tsc compiles src/ to build/)
- Committed: No (in .gitignore)
- Regeneration: Automatic on npm install (prepare script runs tsc)

**node_modules/:**
- Purpose: NPM dependencies
- Generated: By `npm install`
- Committed: No (in .gitignore)

**.planning/:**
- Purpose: GSD framework planning documents
- Committed: Yes
- Structure: Subdirectories per analysis (codebase/, phases/, etc.)

**.github/workflows/:**
- Purpose: CI/CD automation (tests, releases)
- Committed: Yes
- Typical: Test on push, build releases on tag

**demo/:**
- Purpose: Example scripts demonstrating MCP usage
- Committed: Yes
- Usage: Reference for integration documentation

---

*Structure analysis: 2026-02-07*
