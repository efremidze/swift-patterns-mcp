---
phase: 04-test-coverage
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/cli/setup.ts
  - src/cli/setup-utils.ts
  - src/cli/__tests__/setup.test.ts
  - src/utils/__tests__/query-analysis.test.ts
  - src/sources/premium/__tests__/patreon-scoring.test.ts
  - src/sources/premium/__tests__/patreon-dedup.test.ts
autonomous: true

must_haves:
  truths:
    - "Setup wizard outputs correct config snippet and paths for each client/scope"
    - "Query profiling and overlap logic produce stable, testable outputs"
    - "Patreon scoring and deduplication behaviors match expected edge cases"
  artifacts:
    - path: "src/cli/__tests__/setup.test.ts"
      provides: "Setup wizard helper coverage for config snippet/path logic"
      min_lines: 80
    - path: "src/utils/__tests__/query-analysis.test.ts"
      provides: "Query profile + overlap scoring tests"
      min_lines: 80
    - path: "src/sources/premium/__tests__/patreon-scoring.test.ts"
      provides: "Patreon scoring tests with 15+ cases"
      min_lines: 120
    - path: "src/sources/premium/__tests__/patreon-dedup.test.ts"
      provides: "Patreon dedup tests with 15+ cases"
      min_lines: 120
  key_links:
    - from: "src/cli/setup.ts"
      to: "src/cli/setup-utils.ts"
      via: "imported helpers used by CLI"
      pattern: "from './setup-utils'"
    - from: "src/sources/premium/__tests__/patreon-scoring.test.ts"
      to: "src/sources/premium/patreon-scoring.ts"
      via: "applyOverlapBoost/rankPatternsForQuery/selectCreatorsForQuery"
      pattern: "applyOverlapBoost|rankPatternsForQuery|selectCreatorsForQuery"
    - from: "src/sources/premium/__tests__/patreon-dedup.test.ts"
      to: "src/sources/premium/patreon-dedup.ts"
      via: "canonicalizePatternUrl/dedupePatterns"
      pattern: "canonicalizePatternUrl|dedupePatterns"
---

<objective>
Cover premium ranking/dedup logic and setup wizard output with targeted unit tests.

Purpose: Ensure query analysis and Patreon ranking behave deterministically, and setup wizard produces correct config instructions.
Output: New test suites for setup helpers, query analysis, scoring, and dedup.
</objective>

<execution_context>
@./.opencode/get-shit-done/workflows/execute-plan.md
@./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/cli/setup.ts
@src/sources/premium/patreon-scoring.ts
@src/sources/premium/patreon-dedup.ts
@src/utils/query-analysis.ts
@src/config/creators.ts
@src/utils/search-terms.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Setup wizard helper extraction + tests</name>
  <files>src/cli/setup.ts, src/cli/setup-utils.ts, src/cli/__tests__/setup.test.ts</files>
  <action>
Extract testable helpers from `src/cli/setup.ts` into `src/cli/setup-utils.ts` (getServerCommand, getConfigPath, buildSnippet, parseOptions, shouldRunNonInteractive) and update setup.ts to import them without changing CLI behavior. Add `src/cli/__tests__/setup.test.ts` to validate 8+ cases: config path per client/scope, snippet JSON shape for VS Code vs others, install mode command/args, parseOptions flags (`--all`, `--cursor`, `--global`), and shouldRunNonInteractive behavior. Use `vi.spyOn(console, 'log')` where needed to validate output formatting.
  </action>
  <verify>npm test -- src/cli/__tests__/setup.test.ts</verify>
  <done>Setup wizard helpers are covered with 8+ cases and setup CLI behavior is unchanged.</done>
</task>

<task type="auto">
  <name>Task 2: Query analysis + scoring test coverage</name>
  <files>src/utils/__tests__/query-analysis.test.ts, src/sources/premium/__tests__/patreon-scoring.test.ts</files>
  <action>
Add `query-analysis.test.ts` to cover canonicalizeToken, buildQueryProfile variants, computeQueryOverlap scoring, isStrongQueryOverlap thresholds, and compareByOverlapThenScore ordering. Add `patreon-scoring.test.ts` with 15+ cases covering applyOverlapBoost cap/rounding, selectCreatorsForQuery matching vs fallback (mock `withYouTube`), rankPatternsForQuery with overlap results, fallbackToOriginal behavior, and shouldReplaceByQuality decisions. Use stable fixture patterns with relevanceScore/hasCode fields to assert ordering and selection.
  </action>
  <verify>npm test -- src/utils/__tests__/query-analysis.test.ts && npm test -- src/sources/premium/__tests__/patreon-scoring.test.ts</verify>
  <done>Query analysis tests pass and Patreon scoring suite has 15+ deterministic cases.</done>
</task>

<task type="auto">
  <name>Task 3: Patreon deduplication test coverage</name>
  <files>src/sources/premium/__tests__/patreon-dedup.test.ts</files>
  <action>
Create `patreon-dedup.test.ts` with 15+ cases covering: isPatreonPostUrl detection, getPatreonSearchCacheKey normalization and fallback, canonicalizePatternUrl for YouTube/video IDs, Patreon posts/pages, and invalid URLs, buildPatternDedupKey handling file URLs and patreon-page creator scoping, and dedupePatterns behavior for keep-first vs prefer-best (including shouldReplaceByQuality tie-breaks on hasCode). Use deterministic fixtures with varying creators/titles/urls.
  </action>
  <verify>npm test -- src/sources/premium/__tests__/patreon-dedup.test.ts</verify>
  <done>Patreon dedup test suite has 15+ cases and covers all key URL/key behaviors.</done>
</task>

</tasks>

<verification>
- `npm test -- src/cli/__tests__/setup.test.ts` passes
- `npm test -- src/utils/__tests__/query-analysis.test.ts` passes
- `npm test -- src/sources/premium/__tests__/patreon-scoring.test.ts` passes
- `npm test -- src/sources/premium/__tests__/patreon-dedup.test.ts` passes
</verification>

<success_criteria>
- Setup wizard output logic is validated for client/scope combinations
- Patreon scoring/dedup logic has dedicated 15+ case suites
- Query analysis logic is covered with deterministic unit tests
</success_criteria>

<output>
After completion, create `.planning/phases/04-test-coverage/04-02-SUMMARY.md`
</output>
