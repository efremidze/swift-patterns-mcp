---
phase: 04-test-coverage
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/sources/premium/__tests__/youtube.test.ts
  - vitest.setup.ts
autonomous: true

must_haves:
  truths:
    - "YouTube client tests run offline with mocked API fixtures"
    - "YouTube mapping handles missing snippet fields without crashing"
    - "CI test runs do not require native keytar installation"
  artifacts:
    - path: "src/sources/premium/__tests__/youtube.test.ts"
      provides: "Mocked YouTube API tests covering hydration + link extraction"
      min_lines: 90
    - path: "vitest.setup.ts"
      provides: "Conditional keytar mock for CI test environment"
      min_lines: 5
  key_links:
    - from: "src/sources/premium/__tests__/youtube.test.ts"
      to: "src/sources/premium/youtube.ts"
      via: "getChannelVideos/searchVideos with mocked fetch"
      pattern: "getChannelVideos|searchVideos"
    - from: "vitest.setup.ts"
      to: "keytar"
      via: "vi.mock in CI"
      pattern: "vi\.mock\('keytar'"
---

<objective>
Stabilize YouTube tests with mocked fixtures and ensure CI runs without keytar.

Purpose: Replace flaky YouTube tests with deterministic fixtures and remove native keytar dependency in CI.
Output: Mocked YouTube test suite and conditional keytar mock in Vitest setup.
</objective>

<execution_context>
@./.opencode/get-shit-done/workflows/execute-plan.md
@./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/sources/premium/youtube.ts
@vitest.setup.ts
@.github/workflows/ci.yml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Mocked YouTube fixture tests</name>
  <files>src/sources/premium/__tests__/youtube.test.ts</files>
  <action>
Create `youtube.test.ts` that mocks `../../utils/fetch.js` to return fixture JSON for both `search` and `videos` endpoints. Set `process.env.YOUTUBE_API_KEY` in tests and use `vi.resetModules()` with fresh imports to isolate the module-level cache. Cover at least 3 cases mirroring past failures: missing snippet fields mapped to empty strings, fallback to search snippets when `videos` API fails, and extraction of Patreon/code links from descriptions. Assert that getChannelVideos/searchVideos return normalized `Video[]` without throwing.
  </action>
  <verify>npm test -- src/sources/premium/__tests__/youtube.test.ts</verify>
  <done>Mocked YouTube tests pass offline and cover missing snippet and fallback behavior.</done>
</task>

<task type="auto">
  <name>Task 2: CI keytar mock in Vitest setup</name>
  <files>vitest.setup.ts</files>
  <action>
Update `vitest.setup.ts` to conditionally mock `keytar` when `process.env.CI` is set. Import `vi` from `vitest` and return a minimal default export with `getPassword`, `setPassword`, and `deletePassword` mocked to resolve. Keep non-CI behavior unchanged so local environments can still use real keytar.
  </action>
  <verify>npm test</verify>
  <done>CI test runs no longer require native keytar installation.</done>
</task>

</tasks>

<verification>
- `npm test -- src/sources/premium/__tests__/youtube.test.ts` passes
- `npm test` passes with CI keytar mock enabled
</verification>

<success_criteria>
- YouTube tests are deterministic with mocked API fixtures
- CI runs without keytar dependency failures
</success_criteria>

<output>
After completion, create `.planning/phases/04-test-coverage/04-03-SUMMARY.md`
</output>
