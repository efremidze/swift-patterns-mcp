---
phase: 04-test-coverage
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/sources/premium/__tests__/patreon-oauth.test.ts
  - src/__tests__/server.test.ts
  - src/sources/premium/__tests__/patreon-dl.test.ts
autonomous: true

must_haves:
  truths:
    - "OAuth flow returns success/error outcomes under mocked provider responses"
    - "Server startup registers tools and returns errors for unknown tool names"
    - "Patreon download logic handles cookie validation, invalid URLs, and file extraction paths"
    - "Cookie validation rejects injection strings and unsafe characters"
  artifacts:
    - path: "src/sources/premium/__tests__/patreon-oauth.test.ts"
      provides: "Mocked OAuth integration tests for success/error/timeout paths"
      min_lines: 80
    - path: "src/__tests__/server.test.ts"
      provides: "Server startup tool registration and handler error tests"
      min_lines: 80
    - path: "src/sources/premium/__tests__/patreon-dl.test.ts"
      provides: "Patreon download + cookie validation + scan/extraction tests"
      min_lines: 120
  key_links:
    - from: "src/sources/premium/__tests__/patreon-oauth.test.ts"
      to: "src/sources/premium/patreon-oauth.ts"
      via: "startOAuthFlow/refreshAccessToken/isTokenExpired"
      pattern: "startOAuthFlow|refreshAccessToken|isTokenExpired"
    - from: "src/__tests__/server.test.ts"
      to: "src/server.ts"
      via: "startServer with mocked MCP Server"
      pattern: "startServer"
    - from: "src/sources/premium/__tests__/patreon-dl.test.ts"
      to: "src/sources/premium/patreon-dl.ts"
      via: "downloadPost/scanDownloadedContent/saveCookie"
      pattern: "downloadPost|scanDownloadedContent|saveCookie"
---

<objective>
Add critical-path tests for OAuth flow, server startup behavior, Patreon download paths, and cookie injection defenses.

Purpose: Establish reliable coverage for the most security- and functionality-critical flows in Phase 4.
Output: New Vitest suites covering OAuth, server startup/handlers, and Patreon download + cookie validation.
</objective>

<execution_context>
@./.opencode/get-shit-done/workflows/execute-plan.md
@./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/server.ts
@src/tools/registration.ts
@src/sources/premium/patreon-oauth.ts
@src/sources/premium/patreon-dl.ts
@src/utils/paths.ts
@src/sources/premium/__tests__/patreon-integration.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: OAuth flow integration tests with mock provider</name>
  <files>src/sources/premium/__tests__/patreon-oauth.test.ts</files>
  <action>
Create a dedicated OAuth test suite that mocks network + keytar + browser launch. Use `vi.mock` for `../../utils/fetch.js` to return token responses, mock `child_process` to avoid opening a browser, and mock `keytar` to simulate persistence. Cover at least 8 cases including: success callback exchanging code, error query param, missing code path, token exchange non-OK response, refreshAccessToken success, refreshAccessToken failure, isTokenExpired boundary behavior, and timeout path using fake timers. Ensure tests issue an HTTP request to `http://127.0.0.1:9876/callback?code=...` to resolve `startOAuthFlow` without real Patreon calls.
  </action>
  <verify>npm test -- src/sources/premium/__tests__/patreon-oauth.test.ts</verify>
  <done>OAuth tests pass with 8+ cases and no real network/keytar/browser dependencies.</done>
</task>

<task type="auto">
  <name>Task 2: Server startup tool registration + error handling tests</name>
  <files>src/__tests__/server.test.ts</files>
  <action>
Add server startup tests that mock MCP SDK Server/transport and SourceManager behavior. Stub `getToolList`, `getHandler`, `createErrorResponseFromError`, `prefetchAllSources`, and `prefetchEmbeddingModel` to assert: ListTools handler returns tool list based on mocked enabled sources, CallTool routes to handler when present, unknown tool triggers error response, Patreon auto-enable runs when credentials detected, and prefetch hooks fire when enabled. Include a fatal error test by forcing `server.connect` to reject and asserting `process.exit(1)` is invoked. Target 6+ cases.
  </action>
  <verify>npm test -- src/__tests__/server.test.ts</verify>
  <done>Server startup tests cover tool registration, handler routing, and error paths (6+ cases).</done>
</task>

<task type="auto">
  <name>Task 3: Patreon download + cookie injection test coverage</name>
  <files>src/sources/premium/__tests__/patreon-dl.test.ts</files>
  <action>
Create unit tests for patreon-dl covering download error paths, post matching, and file extraction. Use a temp HOME + temp cwd to isolate `.patreon-session` and download directories. Mock `child_process.execFile` to avoid real `npx` execution and assert it receives expected args. Cover: `extractPostId` variations, `saveCookie` rejecting 5+ injection strings (spaces, semicolons, quotes, path traversal, unicode), `downloadPost` error on missing cookie, `downloadPost` error on invalid URL, `downloadPost` success path returning files after scan, `scanDownloadedContent` reading metadata from both `post.json` and `post_info/post-api.json`, zip extraction into Swift/Markdown, `isPostDownloaded` matching by postId/dirName, and `invalidateScanCache` behavior. Target 10+ cases.
  </action>
  <verify>npm test -- src/sources/premium/__tests__/patreon-dl.test.ts</verify>
  <done>Patreon download tests cover extraction, matching, and cookie injection defenses with 10+ cases.</done>
</task>

</tasks>

<verification>
- `npm test -- src/sources/premium/__tests__/patreon-oauth.test.ts` passes
- `npm test -- src/__tests__/server.test.ts` passes
- `npm test -- src/sources/premium/__tests__/patreon-dl.test.ts` passes
</verification>

<success_criteria>
- OAuth, server startup, and patreon-dl paths are covered with mocked integration tests
- Cookie validation has explicit injection/security test cases
</success_criteria>

<output>
After completion, create `.planning/phases/04-test-coverage/04-01-SUMMARY.md`
</output>
