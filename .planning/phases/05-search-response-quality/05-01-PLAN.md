---
phase: 05-search-response-quality
plan: 01
type: execute
---

<objective>
Optimize search performance by caching normalized content during indexing.

Purpose: Eliminate repeated string concatenation in `findMatches()` method (line 170 in search.ts) which happens for every search result.
Output: SearchableDocument with pre-computed `_searchText` field, faster search operations.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-phase.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

**Prior phase context:**
@.planning/phases/03-mcp-tool-refactoring/03-01-SUMMARY.md

**Codebase context:**
@.planning/codebase/CONCERNS.md (search performance section)
@.planning/codebase/ARCHITECTURE.md

**Files to modify:**
@src/utils/search.ts

**Performance concern from CONCERNS.md:**
```
String Concatenation in Search:
- Problem: Full text concatenation happens for every search result
- Files: src/utils/search.ts (lines 170, 216)
- Code: `const searchText = `${doc.title} ${doc.content} ${doc.topics.join(' ')}`.toLowerCase()`
- Improvement path: Cache normalized content during indexing
```

**Established patterns:**
- TypeScript strict mode
- Pure functions in utils
- MiniSearch for full-text search
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add cached search text to SearchableDocument</name>
  <files>src/utils/search.ts</files>
  <action>
Modify the search module to cache normalized search text:

1. Add optional `_searchText?: string` to `SearchableDocument` interface (private, computed field)

2. Update `addDocuments()` method in `SearchIndex` class:
   - After preprocessing documents for indexing, compute `_searchText` for each document
   - Store computed text: `doc._searchText = \`${doc.title} ${doc.content} ${doc.topics.join(' ')}\`.toLowerCase()`
   - Store in the `documents` Map as part of the original document

3. Keep interface change backward-compatible (optional field, computed internally)
  </action>
  <verify>`npm run lint` passes, `npm run build` succeeds</verify>
  <done>SearchableDocument has _searchText field computed during addDocuments()</done>
</task>

<task type="auto">
  <name>Task 2: Use cached search text in findMatches</name>
  <files>src/utils/search.ts</files>
  <action>
Update `findMatches()` private method (line 168-180) to use cached search text:

1. Replace the string concatenation:
   ```typescript
   // Before:
   const searchText = `${doc.title} ${doc.content} ${doc.topics.join(' ')}`.toLowerCase();

   // After:
   const searchText = doc._searchText ?? `${doc.title} ${doc.content} ${doc.topics.join(' ')}`.toLowerCase();
   ```

2. The fallback ensures backward compatibility if somehow called with uncached doc

3. This eliminates O(n*m) string operations where n=results, m=terms per search
  </action>
  <verify>`npm run lint` passes, `npm run build` succeeds, `npm test` passes (if tests exist)</verify>
  <done>findMatches uses cached _searchText instead of recomputing each time</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run lint` passes
- [ ] `npm run build` succeeds
- [ ] No TypeScript errors
- [ ] Search functionality still works (manual test: run MCP server and search)
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- _searchText is computed once during indexing, not per-search
- Backward compatible (optional field, fallback logic)
</success_criteria>

<output>
After completion, create `.planning/phases/05-search-response-quality/05-01-SUMMARY.md`
</output>
