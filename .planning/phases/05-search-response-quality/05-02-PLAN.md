---
phase: 05-search-response-quality
plan: 02
type: execute
---

<objective>
Improve MCP tool response quality with consistent formatting and better metadata.

Purpose: Create a more consistent, informative response format across all pattern-returning tools.
Output: Response formatting utilities and improved handler outputs.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-phase.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

**Prior phase context:**
@.planning/phases/03-mcp-tool-refactoring/03-01-SUMMARY.md
@.planning/phases/05-search-response-quality/05-01-SUMMARY.md

**Codebase context:**
@.planning/codebase/ARCHITECTURE.md
@.planning/codebase/CONVENTIONS.md

**Files to modify:**
@src/tools/handlers/getSwiftPattern.ts
@src/tools/handlers/searchSwiftContent.ts

**Current response format (getSwiftPattern.ts):**
```typescript
const formatted = results.slice(0, 10).map(p => `
## ${p.title}
**Source**: ${p.id.split('-')[0]}
**Quality**: ${p.relevanceScore}/100
**Topics**: ${p.topics.join(', ')}
${p.hasCode ? '**Has Code**: ✅' : ''}

${p.excerpt}...

**[Read full article](${p.url})**
`).join('\n---\n');
```

**Current response format (searchSwiftContent.ts):**
```typescript
const formatted = filtered.slice(0, 10).map(r => `
## ${r.title}
**Source**: ${r.id.split('-')[0]}
${r.hasCode ? '**Code**: ✅' : ''}
${r.excerpt.substring(0, 200)}...
[Read more](${r.url})
`).join('\n---\n');
```

**Issues:**
1. Inconsistent field names ("Code" vs "Has Code")
2. searchSwiftContent truncates excerpt differently
3. No quality score shown in search results
4. Topic display missing in search results

**Established patterns:**
- Handler functions follow ToolHandler type
- Markdown formatting in responses
- Emoji indicators for status
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create response formatting utilities</name>
  <files>src/tools/formatters.ts</files>
  <action>
Create a new utility module for consistent response formatting:

```typescript
// src/tools/formatters.ts

import type { BasePattern } from '../sources/free/rssPatternSource.js';

export interface FormatOptions {
  showQuality?: boolean;
  showTopics?: boolean;
  excerptLength?: number;
  maxResults?: number;
}

const defaultOptions: FormatOptions = {
  showQuality: true,
  showTopics: true,
  excerptLength: 200,
  maxResults: 10,
};

/**
 * Format a single pattern result consistently
 */
export function formatPattern(pattern: BasePattern, options: FormatOptions = {}): string {
  const opts = { ...defaultOptions, ...options };
  const source = pattern.id.split('-')[0];
  const excerpt = pattern.excerpt.length > opts.excerptLength!
    ? pattern.excerpt.substring(0, opts.excerptLength!) + '...'
    : pattern.excerpt;

  const lines = [
    `## ${pattern.title}`,
    `**Source:** ${source}`,
  ];

  if (opts.showQuality) {
    lines.push(`**Quality:** ${pattern.relevanceScore}/100`);
  }

  if (opts.showTopics && pattern.topics.length > 0) {
    lines.push(`**Topics:** ${pattern.topics.join(', ')}`);
  }

  if (pattern.hasCode) {
    lines.push(`**Has Code:** ✅`);
  }

  lines.push('');
  lines.push(excerpt);
  lines.push('');
  lines.push(`**[Read full article](${pattern.url})**`);

  return lines.join('\n');
}

/**
 * Format multiple patterns with consistent separator
 */
export function formatPatternList(
  patterns: BasePattern[],
  options: FormatOptions = {}
): string {
  const opts = { ...defaultOptions, ...options };
  const limited = patterns.slice(0, opts.maxResults!);

  return limited.map(p => formatPattern(p, opts)).join('\n\n---\n\n');
}

/**
 * Format result count summary
 */
export function formatResultSummary(
  found: number,
  displayed: number,
  context?: string
): string {
  if (found === 0) {
    return '';
  }

  if (found > displayed) {
    return `\n*Showing top ${displayed} of ${found} results${context ? ` ${context}` : ''}*`;
  }

  return '';
}
```
  </action>
  <verify>`npm run lint` passes, `npm run build` succeeds</verify>
  <done>formatters.ts exists with formatPattern, formatPatternList, formatResultSummary utilities</done>
</task>

<task type="auto">
  <name>Task 2: Update handlers to use formatters</name>
  <files>src/tools/handlers/getSwiftPattern.ts, src/tools/handlers/searchSwiftContent.ts</files>
  <action>
Update both handlers to use the new formatting utilities:

**getSwiftPattern.ts:**
1. Import formatters: `import { formatPatternList, formatResultSummary } from '../formatters.js';`
2. Replace manual formatting with:
   ```typescript
   const formatted = formatPatternList(results, { showQuality: true, showTopics: true });
   const summary = formatResultSummary(results.length, Math.min(results.length, 10));
   ```
3. Update response text to use formatted output

**searchSwiftContent.ts:**
1. Import formatters: `import { formatPatternList, formatResultSummary } from '../formatters.js';`
2. Replace manual formatting with:
   ```typescript
   const formatted = formatPatternList(filtered, { showQuality: true, showTopics: true });
   const summary = formatResultSummary(filtered.length, Math.min(filtered.length, 10));
   ```
3. Update response text to use formatted output

This ensures both handlers produce identical formatting for patterns.
  </action>
  <verify>`npm run lint` passes, `npm run build` succeeds</verify>
  <done>Both handlers use formatters, responses are consistent</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run lint` passes
- [ ] `npm run build` succeeds
- [ ] No TypeScript errors
- [ ] Both handlers produce consistent response format
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Pattern formatting is centralized in formatters.ts
- Both handlers produce consistent, informative responses
</success_criteria>

<output>
After completion, create `.planning/phases/05-search-response-quality/05-02-SUMMARY.md`
</output>
