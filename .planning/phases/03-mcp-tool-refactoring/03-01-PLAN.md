---
phase: 03-mcp-tool-refactoring
plan: 01
type: execute
---

<objective>
Extract tool handlers from monolithic index.ts to improve maintainability.

Purpose: Reduce index.ts from 515 lines by extracting core handlers to separate files with a registry pattern.
Output: Handler registry + extracted handlers, index.ts reduced to ~200 lines.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-phase.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

**Prior phase context:**
@.planning/phases/01-foundation-error-handling/01-01-SUMMARY.md

**Codebase context:**
@.planning/codebase/ARCHITECTURE.md
@.planning/codebase/CONVENTIONS.md

**File to refactor:**
@src/index.ts

**Current structure (index.ts):**
- Lines 1-96: Imports, tool definitions (CORE_TOOLS, PATREON_TOOLS)
- Lines 136-161: Server setup, ListToolsRequestSchema handler
- Lines 163-503: CallToolRequestSchema with 7-case switch statement
- Lines 506-515: main() function

**Tool handlers in switch (to extract):**
- get_swift_pattern (~65 lines) - Core
- search_swift_content (~45 lines) - Core
- list_content_sources (~40 lines) - Core
- enable_source (~35 lines) - Core
- setup_patreon (~55 lines) - Patreon (keep inline)
- get_patreon_patterns (~65 lines) - Patreon (keep inline)

**Type safety issues:**
- Line 20: `let PatreonSource: any = null`
- Lines 174, 240: `const results: any[] = []`
- Lines 452, 464: Patreon pattern types as `any`

**Constraint:** Maintain backward compatibility - tool names and behavior unchanged.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create handler registry structure</name>
  <files>src/tools/types.ts, src/tools/registry.ts</files>
  <action>
Create the handler infrastructure:

**src/tools/types.ts:**
```typescript
export interface ToolContext {
  sourceManager: SourceManager;
  PatreonSource: typeof PatreonSource | null;
}

export type ToolHandler = (
  args: Record<string, unknown>,
  context: ToolContext
) => Promise<{ content: Array<{ type: string; text: string }>; isError?: boolean }>;
```

**src/tools/registry.ts:**
```typescript
import type { ToolHandler } from './types.js';

const handlers = new Map<string, ToolHandler>();

export function registerHandler(name: string, handler: ToolHandler): void {
  handlers.set(name, handler);
}

export function getHandler(name: string): ToolHandler | undefined {
  return handlers.get(name);
}

export function hasHandler(name: string): boolean {
  return handlers.has(name);
}
```

Keep it simple - just a Map wrapper with register/get.
  </action>
  <verify>`npm run lint` passes</verify>
  <done>Handler types and registry created in src/tools/</done>
</task>

<task type="auto">
  <name>Task 2: Extract core handlers</name>
  <files>src/tools/handlers/getSwiftPattern.ts, src/tools/handlers/searchSwiftContent.ts, src/tools/handlers/listContentSources.ts, src/tools/handlers/enableSource.ts</files>
  <action>
Extract the 4 core handlers to individual files:

**Pattern for each handler file:**
```typescript
import type { ToolHandler } from '../types.js';
import SundellSource from '../../sources/free/sundell.js';
import VanderLeeSource from '../../sources/free/vanderlee.js';

export const getSwiftPatternHandler: ToolHandler = async (args, context) => {
  // Copy logic from switch case
  // Replace sourceManager references with context.sourceManager
  // Fix `any[]` to proper types where feasible
};
```

**Files to create:**
1. `getSwiftPattern.ts` - Extract get_swift_pattern case
2. `searchSwiftContent.ts` - Extract search_swift_content case
3. `listContentSources.ts` - Extract list_content_sources case
4. `enableSource.ts` - Extract enable_source case

Fix `any[]` to `BasePattern[]` or appropriate type where possible.
Keep Patreon handlers in index.ts (more complex, references dynamic import).
  </action>
  <verify>`npm run lint` passes, `npm run build` succeeds</verify>
  <done>4 handler files created with extracted logic</done>
</task>

<task type="auto">
  <name>Task 3: Update index.ts to use registry</name>
  <files>src/index.ts, src/tools/index.ts</files>
  <action>
**Create src/tools/index.ts (barrel export):**
```typescript
export * from './types.js';
export * from './registry.js';

// Register handlers on import
import { registerHandler } from './registry.js';
import { getSwiftPatternHandler } from './handlers/getSwiftPattern.js';
import { searchSwiftContentHandler } from './handlers/searchSwiftContent.js';
import { listContentSourcesHandler } from './handlers/listContentSources.js';
import { enableSourceHandler } from './handlers/enableSource.js';

registerHandler('get_swift_pattern', getSwiftPatternHandler);
registerHandler('search_swift_content', searchSwiftContentHandler);
registerHandler('list_content_sources', listContentSourcesHandler);
registerHandler('enable_source', enableSourceHandler);
```

**Update src/index.ts:**
1. Import registry: `import { getHandler, ToolContext } from './tools/index.js';`
2. Create context object: `const toolContext: ToolContext = { sourceManager, PatreonSource };`
3. Replace switch statement structure:
```typescript
const handler = getHandler(name);
if (handler) {
  return handler(args ?? {}, toolContext);
}

// Remaining cases (Patreon handlers) stay as switch
switch (name) {
  case "setup_patreon": { ... }
  case "get_patreon_patterns": { ... }
  default: throw new Error(`Unknown tool: ${name}`);
}
```

Result: index.ts reduced from ~515 to ~250 lines.
  </action>
  <verify>`npm run lint` passes, `npm run build` succeeds</verify>
  <done>index.ts uses registry for core handlers, Patreon handlers inline</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run lint` passes
- [ ] `npm run build` succeeds
- [ ] Tool names unchanged (backward compatible)
- [ ] index.ts significantly smaller (~250 lines vs 515)
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Handler extraction pattern established
- index.ts reduced by ~50%
- Code compiles and type-checks
</success_criteria>

<output>
After completion, create `.planning/phases/03-mcp-tool-refactoring/03-01-SUMMARY.md`
</output>
