---
phase: 03-architecture-refactoring
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/sources/premium/patreon.ts
  - src/sources/premium/patreon-scoring.ts
  - src/sources/premium/patreon-dedup.ts
  - src/sources/premium/patreon-enrichment.ts
  - src/sources/premium/youtube.ts
  - src/utils/query-analysis.ts
autonomous: true

must_haves:
  truths:
    - "src/sources/premium/patreon.ts is under 300 lines, orchestrating imported scoring/dedup/enrichment/query modules"
    - "YouTube module has zero module-level mutable state — errors returned with results, not stored globally"
    - "Query profile building, token canonicalization, and overlap scoring are in src/utils/query-analysis.ts"
    - "Pattern deduplication and URL canonicalization are in src/sources/premium/patreon-dedup.ts"
    - "Pattern scoring, ranking, and overlap boosting are in src/sources/premium/patreon-scoring.ts"
    - "Pattern enrichment (download-based content fetching) is in src/sources/premium/patreon-enrichment.ts"
    - "All 383 existing tests pass without modification"
  artifacts:
    - path: "src/utils/query-analysis.ts"
      provides: "Query profile building, token canonicalization, overlap computation"
      exports: ["buildQueryProfile", "computeQueryOverlap", "isStrongQueryOverlap", "canonicalizeToken", "QueryProfile", "QueryOverlap"]
    - path: "src/sources/premium/patreon-scoring.ts"
      provides: "Pattern scoring, ranking, overlap boosting"
      exports: ["rankPatternsForQuery", "applyOverlapBoost"]
    - path: "src/sources/premium/patreon-dedup.ts"
      provides: "Pattern deduplication and URL canonicalization"
      exports: ["dedupePatterns", "buildPatternDedupKey", "canonicalizePatternUrl"]
    - path: "src/sources/premium/patreon-enrichment.ts"
      provides: "Pattern enrichment via Patreon post content download"
      exports: ["enrichPatternsWithContent"]
    - path: "src/sources/premium/patreon.ts"
      provides: "Slim orchestrator for Patreon search"
      max_lines: 300
    - path: "src/sources/premium/youtube.ts"
      provides: "YouTube client with no module-level mutable state"
  key_links:
    - from: "src/sources/premium/patreon.ts"
      to: "src/utils/query-analysis.ts"
      via: "import buildQueryProfile, computeQueryOverlap"
      pattern: "buildQueryProfile|computeQueryOverlap"
    - from: "src/sources/premium/patreon.ts"
      to: "src/sources/premium/patreon-dedup.ts"
      via: "import dedupePatterns"
      pattern: "dedupePatterns"
    - from: "src/sources/premium/patreon.ts"
      to: "src/sources/premium/patreon-scoring.ts"
      via: "import rankPatternsForQuery"
      pattern: "rankPatternsForQuery"
    - from: "src/sources/premium/patreon.ts"
      to: "src/sources/premium/patreon-enrichment.ts"
      via: "import enrichPatternsWithContent"
      pattern: "enrichPatternsWithContent"
    - from: "src/sources/premium/youtube.ts"
      to: "callers"
      via: "errors returned in result objects, not stored in module state"
      pattern: "YouTubeResult|error.*null"
---

<objective>
Decompose the monolithic Patreon source (src/sources/premium/patreon.ts, 792 lines) into focused modules and eliminate module-level mutable state from the YouTube client.

Purpose: patreon.ts currently mixes 8 responsibilities (query profiling, API search, video search, scoring, deduplication, enrichment, ranking, caching). Extracting these into dedicated modules makes each independently testable (Phase 4 needs scoring/dedup tests — H5). The YouTube module's shared mutable youtubeStatus object causes state pollution across concurrent requests and prevents reliable error reporting.

Output: 4 new modules (query-analysis.ts, patreon-scoring.ts, patreon-dedup.ts, patreon-enrichment.ts), a slim patreon.ts orchestrator under 300 lines, and a stateless YouTube client.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/sources/premium/patreon.ts
@src/sources/premium/youtube.ts
@src/sources/premium/patreon-dl.ts
@src/sources/premium/patreon-oauth.ts
@src/tools/handlers/getPatreonPatterns.ts
@src/config/creators.ts
@src/utils/search-terms.ts
@src/utils/swift-analysis.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extract query-analysis, scoring, dedup, and enrichment modules from patreon.ts</name>
  <files>
    src/utils/query-analysis.ts
    src/sources/premium/patreon-scoring.ts
    src/sources/premium/patreon-dedup.ts
    src/sources/premium/patreon-enrichment.ts
    src/sources/premium/patreon.ts
  </files>
  <action>
Extract four modules from src/sources/premium/patreon.ts (792 lines). Move functions exactly as-is — no logic changes.

**1. Create src/utils/query-analysis.ts** — Extract query profile building and overlap computation:

Move these functions and their associated types/constants:
- `canonicalizeToken()` (line 120-130)
- `buildQueryProfile()` (line 132-191) and the `QueryProfile` interface (line 48-51)
- `computeQueryOverlap()` (line 203-219) and the `QueryOverlap` interface (line 53-56)
- `isStrongQueryOverlap()` (line 221-234)
- The constants: `MAX_QUERY_VARIANTS`, `PATREON_DEFAULT_QUERY`, `QUERY_OVERLAP_SCORE_CAP`, `QUERY_OVERLAP_RELEVANCE_MULTIPLIER`

Import `normalizeTokens` from `../../utils/search-terms.js` (adjust path since this is in src/utils/).
Actually, since this file IS in src/utils/, import from `./search-terms.js`.

Export all functions and types. Also export the `OverlapScoredPattern` interface (line 58-61) and `compareByOverlapThenScore` function (line 293-298) as they are used by scoring.

**2. Create src/sources/premium/patreon-scoring.ts** — Extract pattern scoring and ranking:

Move these functions:
- `applyOverlapBoost()` (line 236-239)
- `rankPatternsForQuery()` (line 300-331)
- `shouldReplaceByQuality()` (line 333-338) — needed by dedup but logically a scoring concern; export it
- `selectCreatorsForQuery()` (line 193-201)

Import QueryProfile, QueryOverlap, OverlapScoredPattern, computeQueryOverlap, isStrongQueryOverlap, compareByOverlapThenScore, QUERY_OVERLAP_SCORE_CAP, QUERY_OVERLAP_RELEVANCE_MULTIPLIER from `../../utils/query-analysis.js`.
Import PatreonPattern type from `./patreon.js` (or from the types — use the local definition).
Import `withYouTube` from `../../config/creators.js`.

Note: PatreonPattern is defined in patreon.ts AND in src/tools/types.ts. Both are identical. Import from wherever avoids circular dependency — likely from `../premium/patreon.js` or define a shared type. The safest approach: keep PatreonPattern exported from patreon.ts and import it in scoring.

**3. Create src/sources/premium/patreon-dedup.ts** — Extract deduplication logic:

Move these functions:
- `canonicalizePatternUrl()` (line 256-277)
- `buildPatternDedupKey()` (line 279-291)
- `dedupePatterns()` (line 340-357) and the `DedupStrategy` type (line 63)
- `isPatreonPostUrl()` (line 246-248)
- `getPatreonSearchCacheKey()` (line 250-254)

Import `shouldReplaceByQuality` from `./patreon-scoring.js`.
Import PatreonPattern type from `./patreon.js`.
Import `normalizeTokens` from `../../utils/search-terms.js` and `canonicalizeToken` from `../../utils/query-analysis.js` (for getPatreonSearchCacheKey).

**4. Create src/sources/premium/patreon-enrichment.ts** — Extract enrichment logic:

Move the enrichment method `enrichPatternsWithContent` (line 693-750) as a standalone async function:
```typescript
export async function enrichPatternsWithContent(
  patterns: PatreonPattern[],
  filesToPatterns: (files: DownloadedFile[], source: ...) => PatreonPattern[]
): Promise<PatreonPattern[]>
```

The function currently lives as a private method on PatreonSource and calls `this.filesToPatterns()`. Convert it to accept `filesToPatterns` as a callback parameter, or move `filesToPatterns` into this module too.

Actually, the cleanest approach: move BOTH `enrichPatternsWithContent` AND `filesToPatterns` into patreon-enrichment.ts as exported functions. The `filesToPatterns` function (line 755-785) depends on `detectTopics`, `hasCodeContent`, `calculateRelevance` — all from utils. It also uses the Patreon-specific config constants (`patreonTopicKeywords`, `patreonQualitySignals`, `PATREON_BASE_SCORE`, `PATREON_CODE_BONUS`, `PATREON_EXCERPT_LENGTH`). Move those constants too, or pass them as parameters. The simplest: move the constants and `filesToPatterns` into enrichment.ts.

Also move: `downloadedPostToPatterns` (line 484-491), `getDownloadedPatterns` (line 535-559), `videoToPattern` (line 562-580) — these are conversion functions that use `filesToPatterns` and scoring utilities. These should stay in patreon.ts since they're part of the orchestration, OR move the conversion functions too.

Let me be precise about what goes where to keep patreon.ts as orchestrator:

**Into patreon-enrichment.ts:**
- `filesToPatterns()` (lines 755-785) — standalone function, not a method
- `enrichPatternsWithContent()` (lines 693-750) — standalone function using filesToPatterns
- `downloadedPostToPatterns()` (lines 484-491) — standalone function using filesToPatterns
- `videoToPattern()` (lines 562-580) — standalone function
- `getDownloadedPatterns()` (lines 535-559) — standalone function using downloadedPostToPatterns + rankPatternsForQuery + dedupePatterns
- Constants: `PATREON_BASE_SCORE`, `PATREON_CODE_BONUS`, `PATREON_EXCERPT_LENGTH`, `PATREON_DOWNLOADED_RESULTS_LIMIT`, `patreonTopicKeywords`, `patreonQualitySignals`, `getPositiveIntEnv`

These functions import from:
- `./patreon-dl.js` (downloadPost, DownloadedPost, DownloadedFile, scanDownloadedContent, extractPostId)
- `./youtube.js` (Video)
- `../../utils/swift-analysis.js` (detectTopics, hasCodeContent, calculateRelevance)
- `../../config/swift-keywords.js` (createSourceConfig)
- `../../utils/errors.js` (logError)
- `../../utils/logger.js` (logger)
- `./patreon-scoring.js` (rankPatternsForQuery)
- `./patreon-dedup.js` (dedupePatterns)
- `../../utils/query-analysis.js` (buildQueryProfile, QueryProfile)

**5. Slim down src/sources/premium/patreon.ts** to < 300 lines:

What remains in patreon.ts:
- PatreonPattern, CreatorInfo, PatreonSearchMode, PatreonSearchOptions, InternalPatreonSearchOptions interfaces and types
- PatreonCampaign, PatreonMember, PatreonIdentityResponse interfaces (API types)
- `isSwiftRelated()` helper
- `PatreonSource` class with:
  - constructor (cache setup)
  - `isConfigured()`
  - `getSubscribedCreators()`
  - `detectSwiftCreators()`
  - `fetchPatterns()`
  - `searchDirectPostUrl()` (uses isPatreonPostUrl from dedup, downloadedPostToPatterns from enrichment)
  - `searchPatternsInternal()` (orchestrates: calls buildQueryProfile, selectCreatorsForQuery, searchVideos, videoToPattern, rankPatternsForQuery, enrichPatternsWithContent, getDownloadedPatterns, dedupePatterns)
  - `searchPatterns()` (public entry point)
  - `isAvailable()`
- The export default

The remaining methods are the orchestration layer — they call imported functions from the extracted modules.

Update all imports in patreon.ts to reference the new modules. Remove moved functions. Ensure all exports that other files depend on (PatreonPattern, PatreonSource, CreatorInfo) remain exported from patreon.ts.

CRITICAL: Check `src/tools/types.ts` — it has its own PatreonPattern interface. Keep both (they're identical). No changes needed to types.ts.

CRITICAL: Run the full test suite after extraction. The refactoring must be behavior-preserving.
  </action>
  <verify>
1. Run `npx tsc --noEmit` — zero type errors
2. Run `npx vitest run` — all 383 tests pass
3. Count lines: `wc -l src/sources/premium/patreon.ts` shows < 300 lines
4. Verify new files exist: `ls src/utils/query-analysis.ts src/sources/premium/patreon-scoring.ts src/sources/premium/patreon-dedup.ts src/sources/premium/patreon-enrichment.ts`
5. Verify patreon.ts imports from new modules: `grep "import.*from.*patreon-" src/sources/premium/patreon.ts`
  </verify>
  <done>
src/sources/premium/patreon.ts is under 300 lines, orchestrating imports from patreon-scoring.ts, patreon-dedup.ts, patreon-enrichment.ts, and query-analysis.ts. All 383 tests pass without modification.
  </done>
</task>

<task type="auto">
  <name>Task 2: Eliminate module-level mutable state from YouTube client</name>
  <files>
    src/sources/premium/youtube.ts
    src/tools/handlers/getPatreonPatterns.ts
  </files>
  <action>
Refactor src/sources/premium/youtube.ts to eliminate the module-level mutable `youtubeStatus` object and the `recordError()`/`clearError()` functions.

**Current problem:**
- Lines 14-29: Module-level `youtubeStatus` object with `lastError` and `lastErrorTime` fields
- `recordError()` and `clearError()` mutate this shared state
- Concurrent requests share and pollute each other's error state
- `getYouTubeStatus()` returns a snapshot that may be stale or from a different request

**Solution: Return errors with results using a YouTubeResult wrapper type:**

1. Define a result wrapper type at the top of youtube.ts:
```typescript
export interface YouTubeResult<T> {
  data: T;
  error: string | null;
}
```

2. Change `searchVideos()` return type from `Promise<Video[]>` to `Promise<YouTubeResult<Video[]>>`:
```typescript
export async function searchVideos(...): Promise<YouTubeResult<Video[]>> {
  // On success: return { data: videos, error: null }
  // On error: return { data: [], error: 'HTTP 403' } or { data: [], error: 'YOUTUBE_API_KEY not set' }
}
```

3. Change `getChannelVideos()` similarly to return `Promise<YouTubeResult<Video[]>>`.

4. Remove:
- The `youtubeStatus` object
- The `YouTubeStatus` interface
- The `recordError()` function
- The `clearError()` function
- The `getYouTubeStatus()` export

5. Update internal functions `_fetchSearchVideos()` and `_fetchChannelVideos()` to return `YouTubeResult<Video[]>` instead of `Video[]`. Replace `recordError(msg)` calls with returning `{ data: [], error: msg }`. Replace `clearError(); return videos;` with `return { data: videos, error: null }`.

6. The cache wrappers (`youtubeCache.getOrFetch`) in `searchVideos()` and `getChannelVideos()` currently cache `Video[]`. Update them to cache `YouTubeResult<Video[]>`. This means errors also get cached (which is actually fine — the 1-hour TTL prevents hammering a broken API). If you prefer not to cache errors, check the result before caching and only cache successful results.

Actually, the simplest approach that preserves caching behavior: keep caching Video[] internally but wrap the final return. The cache stores raw video arrays. The exported functions return YouTubeResult:

```typescript
export async function searchVideos(...): Promise<YouTubeResult<Video[]>> {
  const apiKey = process.env.YOUTUBE_API_KEY;
  if (!apiKey) {
    return { data: [], error: 'YOUTUBE_API_KEY not set' };
  }

  const cacheKey = `search-${channelId || 'all'}-${query}-${maxResults}`;
  try {
    const videos = await youtubeCache.getOrFetch(cacheKey, async () => {
      return _fetchSearchVideos(apiKey, query, channelId, maxResults);
    }, YOUTUBE_CACHE_TTL);
    return { data: videos, error: null };
  } catch (error) {
    return { data: [], error: toErrorMessage(error) };
  }
}
```

Keep `_fetchSearchVideos` returning `Video[]` (unchanged internally). The error state flows upward through the result type instead of sideways through module globals.

7. **Update callers:**

**src/sources/premium/patreon.ts** (or patreon-enrichment.ts after Task 1): The `searchPatternsInternal` method calls `searchVideos(variant, creator.youtubeChannelId!, MAX_VIDEOS_PER_CREATOR)`. Update to destructure: `const { data: videos } = await searchVideos(...)`. The error is available but patreon.ts already handles empty arrays gracefully — no behavior change needed.

**src/tools/handlers/getPatreonPatterns.ts**: Currently imports `getYouTubeStatus` and displays a warning if YouTube has recent errors. This was the ONLY consumer of the global state. Two options:
  - Option A: Remove the YouTube status warning entirely (the error info is now per-request, not globally tracked).
  - Option B: Thread the error through from the Patreon search results.

Go with Option A — remove the YouTube status check from getPatreonPatterns.ts (lines 63-67). The per-request error is now available in the search result itself, but the handler doesn't have access to individual YouTube call results (they're deep in Patreon search internals). The warning was unreliable anyway (showed errors from OTHER requests). Remove the import of `getYouTubeStatus` and the `ytStatus`/`ytWarning` logic.

Search the codebase for any other imports of `getYouTubeStatus` or `recordError` from youtube.ts and update them.

CRITICAL: Verify no other file imports getYouTubeStatus. Run: `grep -r "getYouTubeStatus\|youtubeStatus" src/` to find all references.
  </action>
  <verify>
1. Run `npx tsc --noEmit` — zero type errors
2. Run `npx vitest run` — all 383 tests pass
3. Verify no module-level mutable state: `grep -n "youtubeStatus\|recordError\|clearError" src/sources/premium/youtube.ts` should show zero results
4. Verify YouTubeResult export: `grep "YouTubeResult" src/sources/premium/youtube.ts`
5. Verify getYouTubeStatus is removed: `grep -r "getYouTubeStatus" src/` should show zero results
  </verify>
  <done>
src/sources/premium/youtube.ts has zero module-level mutable state. searchVideos() and getChannelVideos() return YouTubeResult<Video[]> with per-call error info. The unreliable global status warning is removed from getPatreonPatterns handler. All 383 tests pass.
  </done>
</task>

</tasks>

<verification>
1. `wc -l src/sources/premium/patreon.ts` — must be < 300 lines
2. `grep -c "youtubeStatus\|recordError\|clearError" src/sources/premium/youtube.ts` — must be 0
3. `npx tsc --noEmit` — zero type errors (entire project)
4. `npx vitest run` — all 383 tests pass without modification
5. `ls src/utils/query-analysis.ts src/sources/premium/patreon-scoring.ts src/sources/premium/patreon-dedup.ts src/sources/premium/patreon-enrichment.ts` — all 4 new files exist
6. `grep "YouTubeResult" src/sources/premium/youtube.ts` — type exists and is exported
7. Verify patreon.ts imports from extracted modules (not self-contained logic)
</verification>

<success_criteria>
- src/sources/premium/patreon.ts is under 300 lines, delegating to scoring, dedup, enrichment, and query-analysis modules
- YouTube module has zero module-level mutable state — errors returned with results via YouTubeResult type
- All 383 existing tests pass without modification (backward compatibility)
- TypeScript compiles with zero errors
- No behavioral changes — Patreon search results, YouTube video fetching, and error handling are functionally identical
</success_criteria>

<output>
After completion, create `.planning/phases/03-architecture-refactoring/03-02-SUMMARY.md`
</output>
