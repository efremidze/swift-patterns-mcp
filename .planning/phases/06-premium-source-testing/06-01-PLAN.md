---
phase: 06-premium-source-testing
plan: 01
type: execute
---

<objective>
Add test coverage for YouTube API integration.

Purpose: Ensure YouTube video fetching and search functions work correctly and handle errors gracefully.
Output: Test file `src/sources/premium/youtube.test.ts` with full coverage of exported functions.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-phase.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

**Codebase context:**
@.planning/codebase/TESTING.md

**File to test:**
@src/sources/premium/youtube.ts

**Existing test patterns (reference):**
@src/sources/free/sundell.test.ts

**Established patterns from TESTING.md:**
- Vitest with `describe`, `it`, `expect`, `vi`
- Co-located test files (`*.test.ts` next to source)
- Module mocking via `vi.mock()` at file top
- `vi.stubGlobal('fetch', ...)` for fetch mocking
- Async testing with `async/await`

**Functions to test:**
1. `extractPatreonLink(text)` - Regex to find Patreon URLs (internal helper)
2. `extractCodeLinks(text)` - Regex to find GitHub URLs (internal helper)
3. `getChannelVideos(channelId, maxResults)` - Fetch videos from YouTube API
4. `searchVideos(query, channelId?, maxResults)` - Search YouTube videos
</context>

<tasks>

<task type="auto">
  <name>Task 1: Test helper functions</name>
  <files>src/sources/premium/youtube.test.ts</files>
  <action>
Create the test file with tests for helper functions.

Note: `extractPatreonLink` and `extractCodeLinks` are not exported, but we can test them indirectly through the main functions, OR we can export them for testing.

**Option A (preferred):** Export the helper functions and test directly:
1. In `youtube.ts`, add `export` to `extractPatreonLink` and `extractCodeLinks`
2. Create `youtube.test.ts` with tests:

```typescript
import { describe, it, expect } from 'vitest';
import { extractPatreonLink, extractCodeLinks } from './youtube.js';

describe('YouTube helpers', () => {
  describe('extractPatreonLink', () => {
    it('extracts patreon.com URLs', () => {
      const text = 'Check out my Patreon https://patreon.com/creator for more';
      expect(extractPatreonLink(text)).toBe('https://patreon.com/creator');
    });

    it('handles www prefix', () => {
      const text = 'Support at https://www.patreon.com/example';
      expect(extractPatreonLink(text)).toBe('https://www.patreon.com/example');
    });

    it('returns undefined when no link', () => {
      expect(extractPatreonLink('No patreon here')).toBeUndefined();
    });
  });

  describe('extractCodeLinks', () => {
    it('extracts github.com URLs', () => {
      const text = 'Code at https://github.com/user/repo';
      expect(extractCodeLinks(text)).toEqual(['https://github.com/user/repo']);
    });

    it('extracts gist.github.com URLs', () => {
      const text = 'Gist: https://gist.github.com/user/abc123';
      expect(extractCodeLinks(text)).toEqual(['https://gist.github.com/user/abc123']);
    });

    it('extracts multiple GitHub URLs', () => {
      const text = 'Code: https://github.com/a/b and https://github.com/c/d';
      expect(extractCodeLinks(text)).toHaveLength(2);
    });

    it('returns empty array when no links', () => {
      expect(extractCodeLinks('No code links')).toEqual([]);
    });
  });
});
```
  </action>
  <verify>`npm test src/sources/premium/youtube.test.ts` passes</verify>
  <done>Helper function tests pass, functions exported for testing</done>
</task>

<task type="auto">
  <name>Task 2: Test API functions with mocked fetch</name>
  <files>src/sources/premium/youtube.test.ts</files>
  <action>
Add tests for `getChannelVideos` and `searchVideos` using mocked fetch.

```typescript
import { describe, it, expect, vi, beforeEach, afterEach } from 'vitest';
import { getChannelVideos, searchVideos } from './youtube.js';

describe('YouTube API', () => {
  const originalEnv = process.env;

  beforeEach(() => {
    process.env = { ...originalEnv, YOUTUBE_API_KEY: 'test-key' };
  });

  afterEach(() => {
    process.env = originalEnv;
    vi.restoreAllMocks();
  });

  describe('getChannelVideos', () => {
    it('returns videos with extracted links', async () => {
      vi.stubGlobal('fetch', vi.fn()
        .mockResolvedValueOnce({
          ok: true,
          json: async () => ({
            items: [{ id: { videoId: 'vid1' }, snippet: { title: 'Test', description: 'https://patreon.com/test', publishedAt: '2026-01-01', channelId: 'ch1', channelTitle: 'Test' } }]
          })
        })
        .mockResolvedValueOnce({
          ok: true,
          json: async () => ({
            items: [{ id: 'vid1', snippet: { title: 'Test', description: 'https://patreon.com/test', publishedAt: '2026-01-01', channelId: 'ch1', channelTitle: 'Test', tags: ['swift'] } }]
          })
        }));

      const videos = await getChannelVideos('channelId123');
      expect(videos).toHaveLength(1);
      expect(videos[0].patreonLink).toBe('https://patreon.com/test');
    });

    it('returns empty array when no API key', async () => {
      delete process.env.YOUTUBE_API_KEY;
      const videos = await getChannelVideos('channelId');
      expect(videos).toEqual([]);
    });

    it('handles API errors gracefully', async () => {
      vi.stubGlobal('fetch', vi.fn().mockResolvedValue({ ok: false, status: 403 }));
      const videos = await getChannelVideos('channelId');
      expect(videos).toEqual([]);
    });
  });

  describe('searchVideos', () => {
    it('searches with query', async () => {
      vi.stubGlobal('fetch', vi.fn().mockResolvedValue({
        ok: true,
        json: async () => ({
          items: [{ id: { videoId: 'v1' }, snippet: { title: 'Swift Tutorial', description: '', publishedAt: '2026-01-01', channelId: 'c1', channelTitle: 'Tester' } }]
        })
      }));

      const videos = await searchVideos('swift');
      expect(videos).toHaveLength(1);
      expect(videos[0].title).toBe('Swift Tutorial');
    });

    it('returns empty array on error', async () => {
      vi.stubGlobal('fetch', vi.fn().mockRejectedValue(new Error('Network error')));
      const videos = await searchVideos('swift');
      expect(videos).toEqual([]);
    });
  });
});
```
  </action>
  <verify>`npm test src/sources/premium/youtube.test.ts` passes with all tests</verify>
  <done>All YouTube API tests pass with mocked fetch</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run lint` passes
- [ ] `npm test src/sources/premium/youtube.test.ts` passes
- [ ] All exported functions have test coverage
- [ ] Error handling paths tested
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- youtube.test.ts covers helper functions and API functions
- Tests follow established patterns from sundell.test.ts
</success_criteria>

<output>
After completion, create `.planning/phases/06-premium-source-testing/06-01-SUMMARY.md`
</output>
