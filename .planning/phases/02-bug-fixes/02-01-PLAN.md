---
phase: 02-bug-fixes
plan: 01
type: execute
wave: 1
depends_on: ["01-01"]
files_modified:
  - src/utils/memvid-memory.ts
  - src/sources/premium/youtube.ts
autonomous: true

must_haves:
  truths:
    - "Memvid relevance scores display in a 0-100 range"
    - "YouTube videos with missing snippet fields parse without crashing"
    - "Code detection identifies Swift code blocks beyond single-line heuristics"
    - "Search results with memvid context show accurate relevance percentages"
  artifacts:
    - path: "src/utils/memvid-memory.ts"
      provides: "Memvid search result mapping with correct score scaling and code detection"
    - path: "src/sources/premium/youtube.ts"
      provides: "Safe YouTube video mapping with null-tolerant snippet parsing"
  key_links:
    - from: "src/utils/memvid-memory.ts"
      to: "src/utils/swift-analysis.ts"
      via: "hasCodeContent in memvid hit mapping"
      pattern: "hasCodeContent\(.*snippet"
    - from: "src/utils/memvid-memory.ts"
      to: "relevanceScore"
      via: "memvid hit score scaling"
      pattern: "hit\.score\s*\*\s*100"
    - from: "src/sources/premium/youtube.ts"
      to: "Video.channelId/channelTitle"
      via: "null-safe snippet mapping"
      pattern: "channel(Id|Title)\s*:\s*snippet\.channel(Id|Title)\s*\?\?"
---

<objective>
Fix memvid score scaling and code detection, and make YouTube parsing resilient to missing snippet fields.

Purpose: Restore accurate relevance scoring and prevent crashes from partial YouTube API responses.
Output: Updated memvid search mapping and robust YouTube video mapping.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md
@.planning/codebase/ARCHITECTURE.md
@.planning/codebase/CONVENTIONS.md
@.planning/codebase/CONCERNS.md

@src/utils/memvid-memory.ts
@src/sources/premium/youtube.ts
@src/utils/swift-analysis.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Correct memvid score scaling and code detection</name>
  <files>src/utils/memvid-memory.ts</files>
  <action>
    Update memvid hit mapping so relevance scores scale from 0-1 to 0-100 (use a 100x scale factor).
    Replace the local regex-based code detection with the shared hasCodeContent helper from src/utils/swift-analysis.ts, using the hit snippet (and title if available) as input.
    Keep behavior best-effort: missing snippet data should result in hasCode = false without throwing.
  </action>
  <verify>npm run lint</verify>
  <done>Memvid search results map to relevanceScore in 0-100 range and hasCode derives from shared Swift code detection.</done>
</task>

<task type="auto">
  <name>Task 2: Harden YouTube snippet parsing against missing fields</name>
  <files>src/sources/premium/youtube.ts</files>
  <action>
    Make toVideo accept partial snippet data and default missing fields to safe empty strings.
    Guard mapSearchItems/mapVideoItems so items missing ids or snippets do not throw; skip invalid items or fill defaults without crashing.
    Preserve existing behavior for full responses, including tag extraction and link parsing.
  </action>
  <verify>npm run lint</verify>
  <done>YouTube API responses lacking channelId/channelTitle no longer crash mapping and still return Video entries where possible.</done>
</task>

</tasks>

<verification>
npm run lint
</verification>

<success_criteria>
- Memvid-derived results show relevance percentages in 0-100 range.
- Missing YouTube snippet fields no longer crash parsing.
- Code detection for memvid results uses shared Swift heuristics instead of a single regex.
</success_criteria>

<output>
After completion, create `.planning/phases/02-bug-fixes/02-01-SUMMARY.md`
</output>
