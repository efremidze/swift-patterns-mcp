---
phase: 05-test-infrastructure-hardening
plan: 02
type: execute
wave: 2
depends_on:
  - 05-01
files_modified:
  - src/utils/__tests__/http.test.ts
  - src/utils/__tests__/inflight-dedup.test.ts
  - src/sources/free/__tests__/rssPatternSource.test.ts
  - src/sources/free/__tests__/sundell.test.ts
  - src/sources/free/__tests__/vanderlee.test.ts
  - src/sources/free/__tests__/nilcoalescing.test.ts
  - src/sources/free/__tests__/pointfree.test.ts
  - src/utils/__tests__/cache.test.ts
  - src/utils/__tests__/intent-cache.test.ts
autonomous: true

must_haves:
  truths:
    - "HTTP utilities are covered for success, timeout, abort, and non-OK response paths"
    - "Inflight dedup utility guarantees single execution per key and retries after failure"
    - "Each free source test suite validates at least three explicit error-path behaviors"
    - "Core infrastructure caches have tests for corrupted/missing data and miss accounting"
  artifacts:
    - path: "src/utils/__tests__/http.test.ts"
      provides: "Unit tests for buildHeaders/fetchJson/fetchText error and timeout behavior"
      min_lines: 90
    - path: "src/utils/__tests__/inflight-dedup.test.ts"
      provides: "Concurrency and failure cleanup tests for InflightDeduper"
      min_lines: 70
    - path: "src/sources/free/__tests__/sundell.test.ts"
      provides: "Free source success and error-path coverage"
      contains: "returns []"
    - path: "src/utils/__tests__/cache.test.ts"
      provides: "Infrastructure cache edge/error-path test cases"
      contains: "corrupt"
  key_links:
    - from: "src/utils/__tests__/http.test.ts"
      to: "src/utils/http.ts"
      via: "mocked fetch and timer-driven timeout assertions"
      pattern: "fetchJson|fetchText|buildHeaders"
    - from: "src/sources/free/__tests__/rssPatternSource.test.ts"
      to: "src/sources/free/rssPatternSource.ts"
      via: "parse and article-fetch failure path assertions"
      pattern: "fetchPatterns|processArticle"
    - from: "src/utils/__tests__/intent-cache.test.ts"
      to: "src/utils/intent-cache.ts"
      via: "hit/miss and source fingerprint invalidation checks"
      pattern: "getStats|get|buildCacheKey"
---

<objective>
Expand network and infrastructure resilience coverage by testing HTTP/dedup internals and validating free-source error handling across all source implementations.

Purpose: Catch regression-prone failure paths before runtime and satisfy roadmap M2/M3/M6 + infrastructure coverage goals.
Output: New utility tests and strengthened free-source/infrastructure error-path test suites.
</objective>

<execution_context>
@./.opencode/get-shit-done/workflows/execute-plan.md
@./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-test-coverage/04-02-SUMMARY.md
@src/utils/http.ts
@src/utils/inflight-dedup.ts
@src/sources/free/rssPatternSource.ts
@src/utils/cache.ts
@src/utils/intent-cache.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add HTTP utility and inflight dedup unit suites</name>
  <files>src/utils/__tests__/http.test.ts, src/utils/__tests__/inflight-dedup.test.ts</files>
  <action>Create focused unit tests for `buildHeaders`, `fetchJson`, and `fetchText` covering: auth header injection, successful JSON/text decoding, timeout aborts, explicit AbortSignal handling, and non-OK status errors. Add `InflightDeduper` tests for same-key dedup, different-key parallel execution, map cleanup after resolve/reject, and retry-after-failure behavior. Mock boundaries (`fetch`, timers) and keep tests deterministic.</action>
  <verify>npm test -- src/utils/__tests__/http.test.ts src/utils/__tests__/inflight-dedup.test.ts</verify>
  <done>Both utilities have deterministic unit coverage for core success and failure paths (10+ combined cases each).</done>
</task>

<task type="auto">
  <name>Task 2: Add 3+ error-path cases across all free source suites</name>
  <files>src/sources/free/__tests__/rssPatternSource.test.ts, src/sources/free/__tests__/sundell.test.ts, src/sources/free/__tests__/vanderlee.test.ts, src/sources/free/__tests__/nilcoalescing.test.ts, src/sources/free/__tests__/pointfree.test.ts</files>
  <action>Strengthen free source tests with explicit error-path coverage per suite (minimum three each): RSS parse failures returning empty arrays, article fetch failures falling back to RSS snippets, malformed feed entries with missing fields, upstream non-OK responses, and empty-source/no-results handling. Validate graceful degradation behavior (return empty results, no throw) matches existing conventions from `rssPatternSource.ts` and `logError` pattern.</action>
  <verify>npm test -- src/sources/free/__tests__/rssPatternSource.test.ts src/sources/free/__tests__/sundell.test.ts src/sources/free/__tests__/vanderlee.test.ts src/sources/free/__tests__/nilcoalescing.test.ts src/sources/free/__tests__/pointfree.test.ts</verify>
  <done>All five free-source suites pass with expanded error-path coverage and at least 3 error cases per source suite.</done>
</task>

<task type="auto">
  <name>Task 3: Cover infrastructure module edge/error paths</name>
  <files>src/utils/__tests__/cache.test.ts, src/utils/__tests__/intent-cache.test.ts</files>
  <action>Add tests for cache infrastructure failure scenarios that are currently under-covered: corrupted JSON files, unreadable cache files, cache-key sanitization collision awareness, and stats behavior for cache misses due to source fingerprint mismatch. Keep tests isolated via unique namespaces and temporary files, and assert no unhandled throws for expected failure modes.</action>
  <verify>npm test -- src/utils/__tests__/cache.test.ts src/utils/__tests__/intent-cache.test.ts</verify>
  <done>Infrastructure cache suites validate degraded-path behavior and keep deterministic pass/fail semantics.</done>
</task>

</tasks>

<verification>
- `npm test -- src/utils/__tests__/http.test.ts src/utils/__tests__/inflight-dedup.test.ts` passes
- `npm test -- src/sources/free/__tests__/rssPatternSource.test.ts src/sources/free/__tests__/sundell.test.ts src/sources/free/__tests__/vanderlee.test.ts src/sources/free/__tests__/nilcoalescing.test.ts src/sources/free/__tests__/pointfree.test.ts` passes
- `npm test -- src/utils/__tests__/cache.test.ts src/utils/__tests__/intent-cache.test.ts` passes
</verification>

<success_criteria>
- HTTP and inflight-dedup behavior is validated under concurrency and failure conditions
- Free source test suites include meaningful degraded-path coverage, not just happy paths
- Cache and intent infrastructure modules have explicit tests for corruption and miss accounting
</success_criteria>

<output>
After completion, create `.planning/phases/05-test-infrastructure-hardening/05-02-SUMMARY.md`
</output>
