---
phase: 05-test-infrastructure-hardening
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - vitest.config.ts
  - .github/workflows/ci.yml
  - eslint.config.js
  - src/__tests__/fixtures/patterns.ts
  - src/__tests__/fixtures/tool-context.ts
  - src/tools/handlers/__tests__/harness.ts
  - src/tools/handlers/__tests__/handlers.test.ts
  - src/tools/handlers/__tests__/getPatreonPatterns.test.ts
autonomous: true

must_haves:
  truths:
    - "Coverage runs with V8 provider and fails CI when thresholds are not met"
    - "Handler tests reuse shared fixtures/helpers instead of redefining large inline mocks"
    - "Focused tests (describe.only/it.only/test.only) are blocked by lint rules"
    - "At least two existing handler suites import shared test harness or fixtures"
  artifacts:
    - path: "vitest.config.ts"
      provides: "Coverage provider, include/exclude rules, and threshold gates"
      contains: "coverage"
    - path: "src/__tests__/fixtures/patterns.ts"
      provides: "Reusable deterministic pattern fixtures"
      min_lines: 30
    - path: "src/tools/handlers/__tests__/harness.ts"
      provides: "Shared ToolContext and env setup helpers for handler tests"
      min_lines: 40
    - path: "eslint.config.js"
      provides: "Test quality guardrails for focused tests and non-deterministic patterns"
      contains: "no-restricted-properties"
  key_links:
    - from: "package.json"
      to: "vitest.config.ts"
      via: "test:coverage script invokes coverage-enabled config"
      pattern: "test:coverage"
    - from: ".github/workflows/ci.yml"
      to: "package.json"
      via: "CI runs coverage command and fails on thresholds"
      pattern: "test:coverage|--coverage"
    - from: "src/tools/handlers/__tests__/handlers.test.ts"
      to: "src/tools/handlers/__tests__/harness.ts"
      via: "shared context/fixture imports"
      pattern: "from './harness|from '../../../__tests__/fixtures"
---

<objective>
Establish durable test infrastructure by adding coverage enforcement, reusable shared fixtures, and lint rules that prevent low-quality test patterns.

Purpose: Keep future test expansion fast, deterministic, and CI-enforced rather than ad hoc.
Output: Coverage tooling + thresholds, shared fixture/harness modules, and test-quality lint guardrails.
</objective>

<execution_context>
@./.opencode/get-shit-done/workflows/execute-plan.md
@./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-test-coverage/04-03-SUMMARY.md
@package.json
@vitest.config.ts
@eslint.config.js
@.github/workflows/ci.yml
@src/tools/handlers/__tests__/handlers.test.ts
@src/tools/handlers/__tests__/getPatreonPatterns.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add coverage tooling and CI threshold enforcement</name>
  <files>package.json, vitest.config.ts, .github/workflows/ci.yml</files>
  <action>Install and configure `@vitest/coverage-v8` (per roadmap M1). Add a dedicated `test:coverage` script and enable V8 coverage in `vitest.config.ts` with explicit thresholds for statements/branches/functions/lines and include pattern `src/**/*.ts` while excluding test files, build output, and tooling folders. Update CI to run the coverage command so threshold failures block merges. Use V8 provider (not Istanbul) to match the project stack and keep run time lower.</action>
  <verify>npm run test:coverage</verify>
  <done>Coverage report runs locally, thresholds are enforced, and CI executes the same gate.</done>
</task>

<task type="auto">
  <name>Task 2: Extract shared fixtures and handler test harness</name>
  <files>src/__tests__/fixtures/patterns.ts, src/__tests__/fixtures/tool-context.ts, src/tools/handlers/__tests__/harness.ts, src/tools/handlers/__tests__/handlers.test.ts, src/tools/handlers/__tests__/getPatreonPatterns.test.ts</files>
  <action>Create shared deterministic fixtures in `src/__tests__/fixtures/` and a handler-specific harness for ToolContext/env management. Move duplicated factory and setup logic out of the two large handler test files and refactor those suites to import helpers. Keep behavior and assertions unchanged; this is infrastructure cleanup for maintainability, not feature behavior changes. Avoid random IDs in fixtures so snapshot/text assertions stay stable.</action>
  <verify>npm test -- src/tools/handlers/__tests__/handlers.test.ts src/tools/handlers/__tests__/getPatreonPatterns.test.ts</verify>
  <done>Both handler suites use shared harness/fixtures and still pass with equivalent behavior coverage.</done>
</task>

<task type="auto">
  <name>Task 3: Enforce test quality rules in ESLint</name>
  <files>eslint.config.js</files>
  <action>Add test-file ESLint overrides that block focused tests (`describe.only`, `it.only`, `test.only`) and non-deterministic fixture generation patterns that break repeatability. Scope these rules to test files only so production code rules remain unchanged. Prefer existing ESLint core capabilities over adding extra lint plugins.</action>
  <verify>npm run lint</verify>
  <done>Lint fails on focused tests/non-deterministic test anti-patterns and passes for the current suite.</done>
</task>

</tasks>

<verification>
- `npm run test:coverage` passes and outputs threshold-checked coverage
- `npm test -- src/tools/handlers/__tests__/handlers.test.ts src/tools/handlers/__tests__/getPatreonPatterns.test.ts` passes after fixture extraction
- `npm run lint` passes with new test-quality rules enabled
</verification>

<success_criteria>
- Coverage is a first-class CI gate using `@vitest/coverage-v8`
- Shared fixtures exist under `src/__tests__/fixtures/` and are used by multiple test files
- Test quality safeguards prevent focused-test commits and unstable fixture patterns
</success_criteria>

<output>
After completion, create `.planning/phases/05-test-infrastructure-hardening/05-01-SUMMARY.md`
</output>
