---
phase: 05-test-infrastructure-hardening
plan: 03
type: execute
wave: 2
depends_on:
  - 05-01
files_modified:
  - src/sources/premium/patreon-oauth.ts
  - src/sources/premium/__tests__/patreon-oauth.test.ts
  - src/utils/cache.ts
  - src/utils/intent-cache.ts
  - src/utils/__tests__/cache.test.ts
  - src/utils/__tests__/intent-cache.test.ts
  - scripts/benchmark-mcp.js
  - scripts/load-test-mcp.js
  - package.json
  - docs/benchmarks/README.md
autonomous: true

must_haves:
  truths:
    - "OAuth callback rejects mismatched/missing state and sends PKCE verifier during token exchange"
    - "Intent cache and file cache expose observable hit/miss metrics"
    - "Benchmark baseline exists for five common MCP queries with recorded latency stats"
    - "Load test validates 10 concurrent requests complete without functional degradation"
  artifacts:
    - path: "src/sources/premium/patreon-oauth.ts"
      provides: "OAuth state + PKCE security hardening with callback validation"
      contains: "code_challenge"
    - path: "src/utils/cache.ts"
      provides: "File cache hit/miss statistics and stats accessor"
      contains: "getStats"
    - path: "scripts/load-test-mcp.js"
      provides: "Automated concurrent request load test runner"
      min_lines: 80
    - path: "docs/benchmarks/README.md"
      provides: "Baseline interpretation and target guidance"
      min_lines: 20
  key_links:
    - from: "src/sources/premium/__tests__/patreon-oauth.test.ts"
      to: "src/sources/premium/patreon-oauth.ts"
      via: "auth URL params and callback validation assertions"
      pattern: "state|code_challenge|code_verifier"
    - from: "scripts/benchmark-mcp.js"
      to: "src/integration/test-client.ts"
      via: "MCPTestClient scenario timing"
      pattern: "MCPTestClient"
    - from: "scripts/load-test-mcp.js"
      to: "build/index.js"
      via: "concurrent tool calls against running MCP process"
      pattern: "callTool|Promise.all"
---

<objective>
Harden OAuth security and add operational observability/performance baselines for caches and request handling.

Purpose: Close remaining security and reliability gaps before release readiness.
Output: PKCE+state OAuth flow, cache metrics instrumentation, benchmark baseline, and concurrency load-test automation.
</objective>

<execution_context>
@./.opencode/get-shit-done/workflows/execute-plan.md
@./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-command-injection-elimination/01-01-SUMMARY.md
@.planning/phases/04-test-coverage/04-01-SUMMARY.md
@src/sources/premium/patreon-oauth.ts
@src/utils/cache.ts
@src/utils/intent-cache.ts
@scripts/benchmark-mcp.js
@src/integration/test-client.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement OAuth state + PKCE hardening with tests</name>
  <files>src/sources/premium/patreon-oauth.ts, src/sources/premium/__tests__/patreon-oauth.test.ts</files>
  <action>Add RFC-aligned OAuth protections by generating per-flow `state` and PKCE verifier/challenge (S256), including them in authorization URL params, validating `state` on callback, and sending `code_verifier` during token exchange. Keep public function signatures stable for backward compatibility. Extend OAuth tests to assert state mismatch rejection, missing-state rejection, and token exchange payload includes PKCE fields.</action>
  <verify>npm test -- src/sources/premium/__tests__/patreon-oauth.test.ts</verify>
  <done>OAuth flow requires valid state and PKCE to complete, and tests cover new rejection/success paths.</done>
</task>

<task type="auto">
  <name>Task 2: Add cache observability metrics for file and intent caches</name>
  <files>src/utils/cache.ts, src/utils/intent-cache.ts, src/utils/__tests__/cache.test.ts, src/utils/__tests__/intent-cache.test.ts</files>
  <action>Instrument `FileCache` and `IntentCache` with explicit hit/miss counters and stable `getStats()` accessors. Ensure counters update on memory/file hits, misses, and invalidations consistently. Preserve existing cache semantics; this task adds observability only. Add deterministic tests validating stat increments and reset behavior after `clear()`.</action>
  <verify>npm test -- src/utils/__tests__/cache.test.ts src/utils/__tests__/intent-cache.test.ts</verify>
  <done>Both caches expose accurate hit/miss metrics with passing unit tests for stat behavior.</done>
</task>

<task type="auto">
  <name>Task 3: Establish benchmark baseline and concurrent load test automation</name>
  <files>scripts/benchmark-mcp.js, scripts/load-test-mcp.js, package.json, docs/benchmarks/README.md</files>
  <action>Expand benchmark coverage to five representative query scenarios and record a baseline report under `docs/benchmarks/`. Add a dedicated load-test script that runs at least 10 concurrent MCP tool requests and asserts success-rate and latency guardrails (target: under 500ms for baseline warm-path median/p90 where feasible). Wire scripts in `package.json` (`bench:baseline`, `test:load`) and document how to run/interpret results in `docs/benchmarks/README.md`.</action>
  <verify>npm run bench:baseline && npm run test:load</verify>
  <done>Project has reproducible benchmark + load-test commands and saved baseline guidance for future regressions.</done>
</task>

</tasks>

<verification>
- `npm test -- src/sources/premium/__tests__/patreon-oauth.test.ts` passes with state/PKCE checks
- `npm test -- src/utils/__tests__/cache.test.ts src/utils/__tests__/intent-cache.test.ts` passes with metrics assertions
- `npm run bench:baseline && npm run test:load` produces baseline output and validates 10 concurrent requests
</verification>

<success_criteria>
- OAuth authorization flow uses state + PKCE and rejects tampered callbacks
- Cache observability reports hit/miss rates for both intent and file caching
- Benchmark/load-test baselines exist and can be rerun for regression detection
</success_criteria>

<output>
After completion, create `.planning/phases/05-test-infrastructure-hardening/05-03-SUMMARY.md`
</output>
